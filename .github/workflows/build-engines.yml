name: Build and Deploy CheerpX FNF Launcher

on:
  schedule:
    - cron: '0 3 * * *'
  push:
    branches:
      - main
      - master
  workflow_dispatch:

permissions:
  pages: write
  id-token: write

jobs:
  build_engines:
    name: Build ${{ matrix.engine.name }}
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        engine:
          - name: 'P-Slice Engine'
            repo: 'Psych-Slice/P-Slice'
            haxe_version: '4.3.6'
            install_script: |
              sudo apt-get update && sudo apt-get install -y g++-multilib libvlc-dev libvlccore-dev
              haxelib git flixel https://github.com/Psych-Slice/p-slice-1.0-flixel.git 9b1192a23fcfb456123efa14c63c8506ded20e5e --quiet --skip-dependencies
              haxelib git grig.audio https://gitlab.com/haxe-grig/grig.audio.git cbf91e2180fd2e374924fe74844086aab7891666 
              haxelib git flxanimate https://github.com/Psych-Slice/FlxAnimate.git 82a720663f9ed6328d91a727c2b17501d91e3b11 --skip-dependencies
              haxelib git funkin.vis https://github.com/FunkinCrew/funkVis 22b1ce089dd924f15cdc4632397ef3504d464e90 --skip-dependencies
              haxelib git hxcpp https://github.com/Psych-Slice/hxcpp.git e48576506a270237ec2ec6501c0bedbd03034af1 --quiet --skip-dependencies
              haxelib git openfl https://github.com/FunkinCrew/openfl.git c4fa1dcfc384f07bb537e08cae671f9507fe49e6 --quiet --skip-dependencies
              haxelib git lime https://github.com/Psych-Slice/lime-pslice.git 160f0e0da13b7b9600aca950ae7db30167fafc9b --quiet
              haxelib install flixel-addons 3.3.2 --quiet --skip-dependencies
              haxelib install flixel-tools 1.5.1 --quiet --skip-dependencies
              haxelib install hscript-iris 1.1.3 --quiet --skip-dependencies
              haxelib install tjson 1.4.0 --quiet --skip-dependencies
              haxelib install hxdiscord_rpc 1.2.4 --quiet --skip-dependencies
              haxelib git hxCodec https://github.com/polybiusproxy/hxCodec.git 0a51aed0d9523d22a83e453ce7b593ec7fed4742 --skip-dependencies
              haxelib git linc_luajit https://github.com/superpowers04/linc_luajit 1906c4a96f6bb6df66562b3f24c62f4c5bba14a7 --skip-dependencies
            build_command: 'haxelib run lime build linux -final -32'

          - name: 'V-Slice (Funkin)'
            repo: 'FunkinCrew/Funkin'
            haxe_version: '4.3.6'
            install_script: 'sudo apt-get update && sudo apt-get install -y g++-multilib libvlc-dev libvlccore-dev && haxelib install hmm --quiet && haxelib run hmm install -q'
            build_command: 'haxelib run lime build linux -32'

          - name: 'Codename Engine'
            repo: 'CodenameCrew/CodenameEngine'
            haxe_version: '4.3.7'
            install_script: 'sudo apt-get update && sudo apt-get install -y g++-multilib libvlc-dev libvlccore-dev && haxe -cp commandline -D analyzer-optimize --run Main setup -s'
            build_command: 'haxelib run lime build linux -32'

          - name: 'NovaFlare Engine'
            repo: 'NovaFlare-Engine-Concentration/FNF-NovaFlare-Engine'
            haxe_version: '4.3.7'
            install_script: 'sudo apt-get update && sudo apt-get install -y g++-multilib libvlc-dev libvlccore-dev && haxelib install hmm && haxelib run hmm install'
            build_command: 'haxelib run lime build linux -32'
              
          - name: 'Psych Online'
            repo: 'Snirozu/Funkin-Psych-Online'
            haxe_version: '4.3.7'
            install_script: 'sudo apt-get update && sudo apt-get install -y g++-multilib libvlc-dev libvlccore-dev && haxelib install hmm --quiet && haxelib run hmm install'
            build_command: 'haxelib run lime build Project.xml linux -32'
              
          - name: 'Shadow Engine'
            repo: 'FNF-SE/FNF-Shadow-Engine'
            haxe_version: '4.3.7'
            install_script: 'sudo apt-get update && sudo apt-get install -y g++-multilib libvlc-dev libvlccore-dev && haxelib git hmm https://github.com/FNF-SE/hmm --skip-dependencies --quiet && haxelib run hmm install --quiet'
            build_command: 'haxelib run lime build linux -32'

          - name: 'Psych Engine 1.0.4'
            repo: 'ShadowMario/FNF-PsychEngine'
            git_ref: '1.0.4'
            haxe_version: '4.3.2'
            install_script: |
              sudo apt-get update && sudo apt-get install -y g++-multilib
              haxelib set flixel 5.6.1; haxelib set flixel-addons 3.2.2; haxelib set flixel-tools 1.5.1; haxelib set hxvlc 2.0.1; haxelib set lime 8.1.2; haxelib set openfl 9.3.3; haxelib set tjson 1.4.0; haxelib set hxdiscord_rpc 1.2.4; haxelib set hxcpp-debug-server 1.2.4
              haxelib git flxanimate https://github.com/Dot-Stuff/flxanimate 768740a56b26aa0c072720e0d1236b94afe68e3e
              haxelib git linc_luajit https://github.com/superpowers04/linc_luajit.git
              haxelib git funkin.vis https://github.com/FunkinCrew/funkVis 22b1ce089dd924f15cdc4632397ef3504d464e90
              haxelib git grig.audio https://gitlab.com/haxe-grig/grig.audio.git cbf91e2180fd2e374924fe74844086aab7891666
            build_command: 'haxelib run lime build linux -32'

          - name: 'Psych Engine 0.7.3'
            repo: 'ShadowMario/FNF-PsychEngine'
            git_ref: '0.7.3'
            haxe_version: '4.3.2'
            install_script: |
              sudo apt-get update && sudo apt-get install -y g++-multilib
              haxelib set flixel 5.5.0; haxelib set flixel-addons 3.2.1; haxelib set flixel-tools 1.5.1; haxelib set flixel-ui 2.5.0; haxelib git flxanimate https://github.com/ShadowMario/flxanimate dev; haxelib git hxCodec https://github.com/polybiusproxy/hxCodec.git; haxelib git hxdiscord_rpc https://github.com/MAJigsaw77/hxdiscord_rpc.git; haxelib set lime 8.0.1; haxelib git linc_luajit https://github.com/superpowers04/linc_luajit.git; haxelib set openfl 9.3.2; haxelib git SScript https://github.com/Honton129/SScript-archive; haxelib set tjson 1.4.0
            build_command: 'haxelib run lime build linux -32'

          - name: 'Psych Engine 0.6.3'
            repo: 'ShadowMario/FNF-PsychEngine'
            git_ref: '0.6.3'
            haxe_version: '4.2.5'
            install_script: |
              sudo apt-get update && sudo apt-get install -y g++-multilib
              haxelib git discord_rpc https://github.com/Aidan63/linc_discord-rpc.git; haxelib set flixel-addons 3.0.2; haxelib set flixel-demos 2.9.0; haxelib set flixel-templates 2.6.6; haxelib set flixel-tools 1.5.1; haxelib set flixel-ui 2.5.0; haxelib set flixel 5.2.2; haxelib git flxanimate https://github.com/Dot-Stuff/flxanimate 3.0.4; haxelib set hscript 2.5.0; haxelib git hxCodec https://github.com/polybiusproxy/hxCodec.git; haxelib set lime-samples 7.0.0; haxelib set lime 8.0.1; haxelib git linc_luajit https://github.com/superpowers04/linc_luajit.git; haxelib set openfl 9.2.1
            build_command: 'haxelib run lime build linux -32'
    
    steps:
      - name: Setup Haxe
        uses: krdlab/setup-haxe@v1
        with:
          haxe-version: ${{ matrix.engine.haxe_version }}
      
      - name: Clone Engine (Default Branch)
        if: matrix.engine.git_ref == null || matrix.engine.git_ref == ''
        uses: actions/checkout@v4
        with:
          repository: ${{ matrix.engine.repo }}
          path: 'engine'
          submodules: 'recursive'

      - name: Clone Engine (Specific Tag/Ref)
        if: matrix.engine.git_ref != null && matrix.engine.git_ref != ''
        run: git clone --depth 1 -b ${{ matrix.engine.git_ref }} https://github.com/${{ matrix.engine.repo }}.git engine

      - name: Install Dependencies
        run: |
          haxelib setup ~/haxelib
          ${{ matrix.engine.install_script }}
        working-directory: ./engine

      - name: Build Engine
        run: ${{ matrix.engine.build_command }}
        working-directory: ./engine
      
      - name: Upload Engine Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.engine.name }}
          path: engine/export/release/linux/bin/
          if-no-files-found: error

  package_disk_image:
    name: Package CheerpX Disk Image
    needs: build_engines
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Project Files
        uses: actions/checkout@v4

      - name: Install Build Tools
        run: sudo apt-get update && sudo apt-get install -y podman buildah

      - name: Download All Engine Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./downloaded_engines

      - name: Populate Filesystem Directory
        run: |
          mkdir -p image/cheerpXFS/usr/local/bin/
          echo "Copying compiled engines..."
          for engine_artifact_dir in ./downloaded_engines/*; do
            engine_name=$(basename "$engine_artifact_dir")
            echo "  - Populating /usr/local/bin/${engine_name}"
            # The executable and assets are inside the artifact dir, move them
            mv "${engine_artifact_dir}" "image/cheerpXFS/usr/local/bin/${engine_name}"
          done
          echo "Filesystem populated. Final structure:"
          ls -R image/cheerpXFS/usr/local/bin/

      - name: Build CheerpX ext2 Image
        run: |
          chmod +x ./image/build_image.sh
          cd ./image
          ./build_image.sh
      
      - name: Create Artifact for Deployment
        run: |
          mkdir -p _site
          cp index.html _site/
          cp script.js _site/
          cp cheerpXImage.ext2 _site/
      
      - name: Upload Site for Deployment
        uses: actions/upload-artifact@v4
        with:
          name: gh-pages-site
          path: _site/
          if-no-files-found: error

  deploy_pages:
    name: Deploy to GitHub Pages
    needs: package_disk_image
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
      
    steps:
      - name: Download Site Artifact
        uses: actions/download-artifact@v4
        with:
          name: gh-pages-site
          path: .
      
      - name: Setup GitHub Pages
        uses: actions/configure-pages@v4
      
      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: .
          
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
